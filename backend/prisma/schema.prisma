// Arab Exam – Prisma schema
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  // Local: "sqlite" | Production: "postgresql"
  // Deploy qilganda "postgresql" ga o'zgartiring va DATABASE_URL ni yangilang
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════
// QUESTION BANK TABLES (Multilevel – difficulty based)
// ══════════════════════════════════════════════════

// ──── Grammar Questions (MCQ) ────
model GrammarQuestion {
  id           String   @id @default(cuid())
  difficulty   String   @map("difficulty") // easy | medium | hard
  prompt       String   @map("prompt") // Arabic text
  options      String   @map("options") // JSON: string[] (4 options)
  correctIndex Int      @map("correct_index") // 0..3
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([difficulty])
  @@map("grammar_questions")
}

// ──── Reading Passages + sub-Questions ────
model ReadingPassage {
  id                  String   @id @default(cuid())
  difficulty          String   @map("difficulty") // easy | medium | hard
  passageType         String   @map("passage_type") // short | medium | long
  text                String   @map("text") // Arabic passage
  readingTimeSeconds  Int      @map("reading_time_seconds")
  questionTimeSeconds Int      @map("question_time_seconds")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  questions ReadingQuestion[]

  @@index([difficulty])
  @@map("reading_passages")
}

model ReadingQuestion {
  id           String   @id @default(cuid())
  passageId    String   @map("passage_id")
  prompt       String   @map("prompt")
  options      String   @map("options") // JSON: string[] (4 options)
  correctIndex Int      @map("correct_index")
  orderIndex   Int      @default(0) @map("order_index")
  createdAt    DateTime @default(now()) @map("created_at")

  passage ReadingPassage @relation(fields: [passageId], references: [id], onDelete: Cascade)

  @@index([passageId])
  @@map("reading_questions")
}

// ──── Listening Stages + sub-Questions ────
model ListeningStage {
  id                 String   @id @default(cuid())
  stageType          String   @unique @map("stage_type") // short_dialogue | long_conversation | lecture
  titleArabic        String   @map("title_arabic")
  timingMode         String   @map("timing_mode") // per_question | total
  perQuestionSeconds Int?     @map("per_question_seconds")
  totalSeconds       Int?     @map("total_seconds")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  questions ListeningQuestion[]

  @@map("listening_stages")
}

model ListeningQuestion {
  id           String   @id @default(cuid())
  stageId      String   @map("stage_id")
  difficulty   String   @map("difficulty") // easy | medium | hard
  prompt       String   @map("prompt")
  options      String   @map("options") // JSON: string[] (4 options)
  correctIndex Int      @map("correct_index")
  audioUrl     String   @map("audio_url") // PER QUESTION audio file
  maxPlays     Int      @default(2) @map("max_plays")
  orderIndex   Int      @default(0) @map("order_index")
  createdAt    DateTime @default(now()) @map("created_at")

  stage ListeningStage @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@index([stageId])
  @@map("listening_questions")
}

// ──── Writing Tasks ────
model WritingTask {
  id         String   @id @default(cuid())
  difficulty String   @map("difficulty") // easy | medium | hard
  prompt     String   @map("prompt")     // Arabic topic text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([difficulty])
  @@map("writing_tasks")
}

// ──── Speaking Tasks (coming later) ────
model SpeakingTask {
  id         String   @id @default(cuid())
  difficulty String   @map("difficulty") // easy | medium | hard
  prompt     String   @map("prompt")     // Arabic topic text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([difficulty])
  @@map("speaking_tasks")
}

// ══════════════════════════════════════════════════
// LEGACY QUESTION BANK (keeping for backward compat)
// ══════════════════════════════════════════════════

model QuestionBank {
  id            String   @id @default(cuid())
  level         String   @map("level")
  section       String   @map("section")
  taskType      String   @map("task_type")
  prompt        String   @map("prompt")
  options       String?  @map("options")
  correctAnswer String   @map("correct_answer")
  transcript    String?  @map("transcript")
  passage       String?  @map("passage")
  audioUrl      String?  @map("audio_url")
  rubric        String?  @map("rubric")
  difficulty    Int      @default(3) @map("difficulty")
  tags          String?  @map("tags")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  attemptQuestions AttemptQuestion[]

  @@index([level, section])
  @@map("question_bank")
}

// ══════════════════════════════════════════════════
// USER + AUTH TABLES
// ══════════════════════════════════════════════════

model User {
  id                    String    @id @default(cuid())
  email                 String    @unique
  passwordHash          String    @default("") @map("password_hash")
  fullName              String    @map("full_name")
  googleId              String?   @unique @map("google_id")
  avatarUrl             String?   @map("avatar_url")
  subscriptionTier      String    @default("FREE") @map("subscription_tier")
  subscriptionExpiresAt DateTime? @map("subscription_expires_at")
  languagePreference    String    @default("uz") @map("language_preference")
  lastLogin             DateTime? @map("last_login")
  isAdmin               Boolean   @default(false) @map("is_admin")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  attempts            UserExamAttempt[]
  progress            UserProgress?
  aiTutorConversations AITutorConversation[]
  payments            Payment[]
  subscriptions       Subscription[]
  purchases           Purchase[]
  usageTracking       UsageTracking[]

  @@map("users")
}

// ══════════════════════════════════════════════════
// SUBSCRIPTION + ACCESS CONTROL TABLES
// ══════════════════════════════════════════════════

model Subscription {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  planType  String   @map("plan_type")            // "free" | "pro"
  startedAt DateTime @default(now()) @map("started_at")
  expiresAt DateTime @map("expires_at")
  status    String   @default("active") @map("status") // "active" | "expired" | "cancelled"
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@map("subscriptions")
}

model Purchase {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  productType    String    @map("product_type")      // "mock_exam"
  quantity       Int       @default(1) @map("quantity")
  remainingUses  Int       @default(1) @map("remaining_uses")
  expiresAt      DateTime  @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, productType])
  @@map("purchases")
}

model UsageTracking {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  type        String   @map("type")             // "mock" | "writing" | "speaking"
  usedCount   Int      @default(0) @map("used_count")
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, periodStart])
  @@index([userId, type])
  @@map("usage_tracking")
}

// ══════════════════════════════════════════════════
// EXAM STRUCTURE TABLES
// ══════════════════════════════════════════════════

model ExamType {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  sections   ExamSection[]
  mockExams  MockExam[]

  @@map("exam_types")
}

model ExamSection {
  id         String   @id @default(cuid())
  examTypeId String   @map("exam_type_id")
  name       String
  order      Int      @default(0)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  examType  ExamType   @relation(fields: [examTypeId], references: [id], onDelete: Cascade)
  questions Question[]

  @@map("exam_sections")
}

model Question {
  id            String       @id @default(cuid())
  examSectionId String       @map("exam_section_id")
  questionType  String       @map("question_type")
  questionText  String       @map("question_text")
  options       String?
  correctAnswer String?      @map("correct_answer")
  points        Int          @default(1)
  order         Int          @default(0)
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  examSection     ExamSection      @relation(fields: [examSectionId], references: [id], onDelete: Cascade)
  mockExamQuestions MockExamQuestion[]
  userAnswers     UserAnswer[]

  @@map("questions")
}

model MockExam {
  id                String   @id @default(cuid())
  examTypeId        String   @map("exam_type_id")
  title             String
  description       String?
  durationMinutes   Int      @map("duration_minutes")
  useAiGeneration   Boolean  @default(false) @map("use_ai_generation")
  numberOfQuestions Int?     @map("number_of_questions")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  examType  ExamType          @relation(fields: [examTypeId], references: [id], onDelete: Cascade)
  questions MockExamQuestion[]
  attempts  UserExamAttempt[]

  @@map("mock_exams")
}

model MockExamQuestion {
  id          String   @id @default(cuid())
  mockExamId  String   @map("mock_exam_id")
  questionId  String   @map("question_id")
  order       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  mockExam MockExam  @relation(fields: [mockExamId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([mockExamId, questionId])
  @@map("mock_exam_questions")
}

// ══════════════════════════════════════════════════
// ATTEMPT + ANSWER TABLES
// ══════════════════════════════════════════════════

model UserExamAttempt {
  id                 String        @id @default(cuid())
  userId             String        @map("user_id")
  mockExamId         String?       @map("mock_exam_id")
  level              String?       @map("level")
  startedAt          DateTime      @default(now()) @map("started_at")
  completedAt        DateTime?     @map("completed_at")
  status             String        @default("IN_PROGRESS")
  totalScore         Int?          @map("total_score")
  maxPossibleScore   Int?          @map("max_possible_score")
  percentage         Float?        @map("percentage")
  cefrLevelAchieved  String?       @map("cefr_level_achieved")
  cefrFeedback       String?       @map("cefr_feedback")
  sectionScores      String?       @map("section_scores")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  mockExam        MockExam?       @relation(fields: [mockExamId], references: [id], onDelete: SetNull)
  attemptQuestions AttemptQuestion[]
  answers         UserAnswer[]

  @@map("user_exam_attempts")
}

model AttemptQuestion {
  id                 String         @id @default(cuid())
  attemptId          String         @map("attempt_id")
  sourceQuestionId   String?        @map("source_question_id")
  order              Int            @default(0)
  section            String         @default("reading") @map("section")
  taskType           String         @default("mcq") @map("task_type")
  questionType       String         @default("MULTIPLE_CHOICE") @map("question_type")
  questionText       String         @map("question_text")
  transcript         String?        @map("transcript")
  passage            String?        @map("passage")
  options            String?
  correctAnswer      String?        @map("correct_answer")
  rubric             String?        @map("rubric")
  points             Int            @default(1) @map("points")
  maxScore           Int?           @map("max_score")
  wordLimit          Int?           @map("word_limit")
  audioUrl           String?        @map("audio_url")
  createdAt          DateTime       @default(now()) @map("created_at")

  attempt        UserExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  sourceQuestion QuestionBank?   @relation(fields: [sourceQuestionId], references: [id], onDelete: SetNull)
  userAnswers    UserAnswer[]

  @@map("attempt_questions")
}

model UserAnswer {
  id                String   @id @default(cuid())
  attemptId         String   @map("attempt_id")
  questionId        String?  @map("question_id")
  attemptQuestionId String?  @map("attempt_question_id")
  answerText        String?  @map("answer_text")
  audioUrl          String?  @map("audio_url")
  isCorrect         Boolean? @map("is_correct")
  pointsEarned      Int?     @map("points_earned")
  score             Float?   @map("score")
  aiFeedback        String?  @map("ai_feedback")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  attempt         UserExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question        Question?       @relation(fields: [questionId], references: [id], onDelete: Cascade)
  attemptQuestion AttemptQuestion? @relation(fields: [attemptQuestionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, attemptQuestionId])
  @@unique([attemptId, questionId])
  @@map("user_answers")
}

// ══════════════════════════════════════════════════
// MISC TABLES
// ══════════════════════════════════════════════════

model UserProgress {
  id                  String   @id @default(cuid())
  userId              String   @unique @map("user_id")
  totalExamsTaken     Int      @default(0) @map("total_exams_taken")
  skillScores         String?  @map("skill_scores")
  currentStreakDays   Int      @default(0) @map("current_streak_days")
  currentCefrEstimate String?  @map("current_cefr_estimate")
  lastActivityAt      DateTime? @map("last_activity_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_progress")
}

model AITutorConversation {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  questionAsked String   @map("question_asked")
  aiResponse    String   @map("ai_response")
  tokensUsed    Int?     @map("tokens_used")
  createdAt     DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_tutor_conversations")
}

model Payment {
  id                String        @id @default(cuid())
  userId            String        @map("user_id")
  amount            Int           // in UZS (so'm)
  currency          String        @default("UZS")
  status            String        @default("PENDING")       // PENDING | COMPLETED | CANCELLED
  provider          String        @default("click")          // click | payme
  planId            String?       @map("plan_id")
  paymentProviderId String?       @unique @map("payment_provider_id") // Click trans id
  paymeTransId      String?       @unique @map("payme_trans_id")      // Payme transaction id
  paymeState        Int?          @map("payme_state")                  // Payme state: 1=created, 2=completed, -1=cancelled_before, -2=cancelled_after
  paymeCreateTime   DateTime?     @map("payme_create_time")
  paymePerformTime  DateTime?     @map("payme_perform_time")
  paymeCancelTime   DateTime?     @map("payme_cancel_time")
  cancelReason      Int?          @map("cancel_reason")
  paidAt            DateTime?     @map("paid_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}
